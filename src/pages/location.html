<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Get Location</title>
</head>

<body>
  <script>
    function getLocation() {
      return new Promise((resolve, reject) => {
        const { geolocation } = navigator
        if (!geolocation) reject('GPS를 지원하지 않습니다')
        else {
          const options = {
            enableHighAccuracy: false,
            maximumAge: 0,
            timeout: Infinity
          }
          geolocation.getCurrentPosition(({ coords }) => resolve(coords), err => reject(err), options)
        }
      })
    }


    function getAddr(latitude, longitude) {
      const GOOGLE_API_KEY = 'AIzaSyD-basIV4EJ7s-H7I2EqxDT33sAweSVCYw'
      return fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${latitude},${longitude}&language=ko&key=${GOOGLE_API_KEY}`)
    }

    function getTmTx(dong) { // CORS
      const key = '%2B%2BKoCiedn%2FxxVDEbkNoKDypjWPZwCxnsXs4bufrpYQIW43L%2FwJaULU9c8jJH91UXbHFLvYwRuFQTXkRMqCfQJQ%3D%3D'
      const umdName = encodeURI(dong)
      return fetch(`http://openapi.airkorea.or.kr/openapi/services/rest/MsrstnInfoInqireSvc/getTMStdrCrdnt?umdName=${umdName}&pageNo=1&numOfRows=10&ServiceKey=${key}&_returnType=json`)
    }

    (async function () {
      try {
        const { latitude, longitude } = await getLocation()
        console.log({ latitude, longitude })
        const res = await getAddr(latitude, longitude)
        const data = await res.json()
        const dong = data.results[0].formatted_address.split(' ')[3]

        const res2 = await getTmTx(dong)
        const data2 = await res2.json()
        console.log({ data2 })
      } catch (err) {
        console.log({ err })
      }
    })()

  </script>
</body>

</html>